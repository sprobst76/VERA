name: Build & Deploy

on:
  push:
    branches: [main]

jobs:
  # ── Backend-Tests ─────────────────────────────────────────────────────────────
  test-backend:
    name: Backend tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: |
            backend/requirements.txt
            backend/requirements-dev.txt

      - name: Install dependencies
        run: pip install -r requirements.txt -r requirements-dev.txt

      - name: Run tests
        run: python3 -m pytest tests/ -q --tb=short

  # ── Frontend-Tests ────────────────────────────────────────────────────────────
  test-frontend:
    name: Frontend tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npx vitest run

  # ── Backend-Image bauen & pushen ─────────────────────────────────────────────
  build-backend:
    name: Backend image
    runs-on: ubuntu-latest
    needs: [test-backend]
    permissions:
      contents: read
      packages: write
    outputs:
      image: ${{ steps.meta.outputs.tags }}
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/vera-backend
          tags: type=raw,value=latest

      - uses: docker/build-push-action@v5
        with:
          context: .
          file: deploy/Dockerfile.backend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          # GitHub Actions Cache (layer-genau, kostenlos)
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend

  # ── Frontend-Image bauen & pushen ────────────────────────────────────────────
  build-frontend:
    name: Frontend image
    runs-on: ubuntu-latest
    needs: [test-frontend]
    permissions:
      contents: read
      packages: write
    outputs:
      image: ${{ steps.meta.outputs.tags }}
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/vera-frontend
          tags: type=raw,value=latest

      - uses: docker/build-push-action@v5
        with:
          context: .
          file: deploy/Dockerfile.frontend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          build-args: |
            NEXT_PUBLIC_API_URL=${{ vars.NEXT_PUBLIC_API_URL }}
            NEXT_PUBLIC_DEMO_SLUG=${{ vars.NEXT_PUBLIC_DEMO_SLUG }}
          # Separate Cache-Scope wegen anderem Dockerfile
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend

  # ── VPS: pull + restart + migrate ────────────────────────────────────────────
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    environment: production
    steps:
      - name: SSH deploy
        uses: appleboy/ssh-action@v1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_ACTOR: ${{ github.actor }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: GH_TOKEN,GH_ACTOR
          script: |
            set -e
            # GHCR login (GITHUB_TOKEN ist 24h gültig, reicht für den Pull)
            echo "$GH_TOKEN" | docker login ghcr.io -u "$GH_ACTOR" --password-stdin

            cd /srv/vera

            # git pull für deploy.sh / docker-compose.yml Updates
            git pull --ff-only

            # Images ziehen (nur geänderte Layer werden heruntergeladen)
            docker compose -p vera -f deploy/docker-compose.yml pull

            # Rolling restart: erst Backend, dann Frontend (kein simultaner Ausfall)
            docker compose -p vera -f deploy/docker-compose.yml up -d --no-deps vera-api
            sleep 5

            # Migrationen
            docker compose -p vera -f deploy/docker-compose.yml exec -T vera-api alembic upgrade head

            # Frontend + Celery erst hochfahren wenn Backend bereit ist
            docker compose -p vera -f deploy/docker-compose.yml up -d --no-deps vera-web vera-celery-worker vera-celery-beat

            # Alte Images aufräumen
            docker image prune -f

            echo "✓ Deploy abgeschlossen"
